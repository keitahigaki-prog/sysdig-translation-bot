name: Daily Sysdig Translation

on:
  schedule:
    # æ¯Žæ—¥ JST 10:00 (UTC 01:00) ã«å®Ÿè¡Œ
    - cron: '0 1 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  translate:
    runs-on: ubuntu-latest

    permissions:
      contents: write # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å®Œå…¨ãªå±¥æ­´ã‚’å–å¾—

      - name: Setup jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run translation script
        id: translate
        run: |
          chmod +x translate_simple.sh
          ./translate_simple.sh
        continue-on-error: true

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit and push translation
        run: |
          git add articles/ translated.json logs/

          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            ARTICLE_DATE=$(date +%Y-%m-%d)
            ARTICLE_FILE=$(ls -t articles/${ARTICLE_DATE}_*.md 2>/dev/null | head -1)

            if [ -n "$ARTICLE_FILE" ]; then
              ARTICLE_NAME=$(basename "$ARTICLE_FILE" .md | sed "s/${ARTICLE_DATE}_//")
              git commit -m "ðŸ¤– Add translation: ${ARTICLE_NAME} (${ARTICLE_DATE})"
            else
              git commit -m "ðŸ¤– Update translations (${ARTICLE_DATE})"
            fi

            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        if: always()
        run: |
          echo "## ç¿»è¨³ã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TOTAL=$(grep -v "^$" <<< "$(grep -A 100 'ARTICLES=' translate_simple.sh | grep '|' | head -34)" | wc -l)
          TRANSLATED=$(jq '. | length' translated.json 2>/dev/null || echo 0)
          REMAINING=$((TOTAL - TRANSLATED))
          PERCENTAGE=$((TRANSLATED * 100 / TOTAL))

          echo "ðŸ“Š **é€²æ—çŠ¶æ³**" >> $GITHUB_STEP_SUMMARY
          echo "- ç·è¨˜äº‹æ•°: ${TOTAL}" >> $GITHUB_STEP_SUMMARY
          echo "- ç¿»è¨³æ¸ˆã¿: ${TRANSLATED} (${PERCENTAGE}%)" >> $GITHUB_STEP_SUMMARY
          echo "- æœªç¿»è¨³: ${REMAINING}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æœ€æ–°ã®ç¿»è¨³è¨˜äº‹ã‚’è¡¨ç¤º
          if [ -f translated.json ] && [ "$TRANSLATED" -gt 0 ]; then
            echo "ðŸ“ **æœ€æ–°ã®ç¿»è¨³**" >> $GITHUB_STEP_SUMMARY
            jq -r '.[-1] | "- [\(.title)](\(.file)) - \(.date)"' translated.json >> $GITHUB_STEP_SUMMARY
          fi
